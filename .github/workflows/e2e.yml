name: E2E Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run every 6 hours to catch integration drift
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  e2e-precision-intelligence:
    name: E2E - Precision ‚Üí Intelligence
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: üì• Checkout agro-tech-ecosystem
        uses: actions/checkout@v4
        with:
          path: agro-tech-ecosystem
      
      - name: üì• Checkout Precision-Agriculture-Platform
        uses: actions/checkout@v4
        with:
          repository: avilaops/Precision-Agriculture-Platform
          path: Precision-Agriculture-Platform
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üì• Checkout CanaSwarm-Intelligence
        uses: actions/checkout@v4
        with:
          repository: avilaops/CanaSwarm-Intelligence
          path: CanaSwarm-Intelligence
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêã Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
      
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install E2E test dependencies
        run: |
          pip install --user requests pytest pytest-timeout
      
      - name: üöÄ Start services with Docker Compose
        working-directory: agro-tech-ecosystem
        run: |
          docker compose -f docker-compose.e2e.yml up -d --build
          echo "Services started, waiting for health checks..."
      
      - name: ‚è≥ Wait for services to be healthy
        working-directory: agro-tech-ecosystem
        timeout-minutes: 3
        run: |
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT+1))
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Check if both services report healthy
            PRECISION_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' precision-api-e2e 2>/dev/null || echo "unknown")
            INTELLIGENCE_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' intelligence-api-e2e 2>/dev/null || echo "unknown")
            
            echo "  Precision API: $PRECISION_HEALTH"
            echo "  Intelligence API: $INTELLIGENCE_HEALTH"
            
            if [ "$PRECISION_HEALTH" = "healthy" ] && [ "$INTELLIGENCE_HEALTH" = "healthy" ]; then
              echo "‚úÖ All services are healthy!"
              exit 0
            fi
            
            sleep 2
          done
          
          echo "‚ùå Services failed to become healthy after $MAX_ATTEMPTS attempts"
          docker compose -f docker-compose.e2e.yml ps
          docker compose -f docker-compose.e2e.yml logs
          exit 1
      
      - name: üß™ Run E2E Integration Test
        working-directory: agro-tech-ecosystem
        timeout-minutes: 3
        run: |
          python integration/test_precision_to_intelligence.py
      
      - name: üìã Show container logs (on failure)
        if: failure()
        working-directory: agro-tech-ecosystem
        run: |
          echo "=== Docker Compose Status ==="
          docker compose -f docker-compose.e2e.yml ps
          echo ""
          echo "=== Precision API Logs ==="
          docker compose -f docker-compose.e2e.yml logs precision-api
          echo ""
          echo "=== Intelligence API Logs ==="
          docker compose -f docker-compose.e2e.yml logs intelligence-api
      
      - name: üõë Stop services
        if: always()
        working-directory: agro-tech-ecosystem
        run: |
          docker compose -f docker-compose.e2e.yml down -v
      
      - name: üíæ Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            agro-tech-ecosystem/integration/*.log
          retention-days: 7
          if-no-files-found: ignore
  
  health-report:
    name: üìà Integration Health Report
    runs-on: ubuntu-latest
    needs: e2e-precision-intelligence
    if: always()
    
    steps:
      - name: üìä Report Status
        run: |
          if [ "${{ needs.e2e-precision-intelligence.result }}" == "success" ]; then
            echo "‚úÖ Ecosystem Integration: HEALTHY"
            echo "All critical data flows validated successfully."
          else
            echo "‚ùå Ecosystem Integration: DEGRADED"
            echo "E2E tests failed. Check logs for details."
            exit 1
          fi
