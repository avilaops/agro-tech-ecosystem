name: E2E Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run every 6 hours to catch integration drift
    - cron: '0 */6 * * *'
  workflow_dispatch:

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e-precision-intelligence:
    name: E2E - Precision ‚Üí Intelligence
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
    
    steps:
      - name: üì• Checkout agro-tech-ecosystem
        uses: actions/checkout@v4
        with:
          path: workspace/agro-tech-ecosystem
      
      - name: üì• Checkout Precision-Agriculture-Platform
        uses: actions/checkout@v4
        with:
          repository: avilaops/Precision-Agriculture-Platform
          path: workspace/Precision-Agriculture-Platform
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üì• Checkout CanaSwarm-Intelligence
        uses: actions/checkout@v4
        with:
          repository: avilaops/CanaSwarm-Intelligence
          path: workspace/CanaSwarm-Intelligence
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêã Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install E2E test dependencies
        working-directory: workspace/agro-tech-ecosystem
        run: |
          python -m pip install --upgrade pip
          pip install requests pytest pytest-timeout tenacity
      
      - name: ÔøΩ Debug docker compose configuration
        working-directory: workspace/agro-tech-ecosystem
        run: |
          echo "=== Docker Compose Config Validation ==="
          docker compose -f docker-compose.e2e.yml config
          echo ""
          echo "=== Build Context Check ==="
          ls -la ../Precision-Agriculture-Platform/ | head -20 || echo "Precision path not found"
          ls -la ../CanaSwarm-Intelligence/ | head -20 || echo "Intelligence path not found"
      
      - name: üöÄ Start services with Docker Compose
        working-directory: workspace/agro-tech-ecosystem
        env:
          DOCKER_BUILDKIT: '1'
        run: |
          docker compose -f docker-compose.e2e.yml up -d --build
          echo ""
          echo "=== Services Started ==="
          docker compose -f docker-compose.e2e.yml ps
          echo ""
          echo "=== Initial Logs (first 50 lines) ==="
          docker compose -f docker-compose.e2e.yml logs --tail=50
      
      - name: ‚è≥ Wait for services to be healthy
        working-directory: workspace/agro-tech-ecosystem
        timeout-minutes: 3
        run: |
          MAX_ATTEMPTS=60
          ATTEMPT=0
          
          # Get container IDs from docker compose (robust, works regardless of container names)
          PRECISION_ID=$(docker compose -f docker-compose.e2e.yml ps -q precision-api)
          INTELLIGENCE_ID=$(docker compose -f docker-compose.e2e.yml ps -q intelligence-api)
          
          if [ -z "$PRECISION_ID" ] || [ -z "$INTELLIGENCE_ID" ]; then
            echo "‚ùå Could not resolve container IDs from docker compose."
            docker compose -f docker-compose.e2e.yml ps
            docker compose -f docker-compose.e2e.yml logs
            exit 1
          fi
          
          echo "Container IDs resolved:"
          echo "  Precision API: $PRECISION_ID"
          echo "  Intelligence API: $INTELLIGENCE_ID"
          echo ""
          
          # Check if containers are running first
          PRECISION_RUNNING=$(docker inspect --format='{{.State.Running}}' "$PRECISION_ID" 2>/dev/null || echo "false")
          INTELLIGENCE_RUNNING=$(docker inspect --format='{{.State.Running}}' "$INTELLIGENCE_ID" 2>/dev/null || echo "false")
          
          echo "  Precision Running: $PRECISION_RUNNING"
          echo "  Intelligence Running: $INTELLIGENCE_RUNNING"
          echo ""
          
          if [ "$PRECISION_RUNNING" != "true" ] || [ "$INTELLIGENCE_RUNNING" != "true" ]; then
            echo "‚ùå One or more containers not running!"
            docker compose -f docker-compose.e2e.yml ps
            docker compose -f docker-compose.e2e.yml logs
            exit 1
          fi
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT+1))
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Check if both services report healthy
            PRECISION_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' "$PRECISION_ID" 2>/dev/null || echo "unknown")
            INTELLIGENCE_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' "$INTELLIGENCE_ID" 2>/dev/null || echo "unknown")
            
            echo "  Precision API: $PRECISION_HEALTH"
            echo "  Intelligence API: $INTELLIGENCE_HEALTH"
            
            if [ "$PRECISION_HEALTH" = "healthy" ] && [ "$INTELLIGENCE_HEALTH" = "healthy" ]; then
              echo "‚úÖ All services are healthy!"
              exit 0
            fi
            
            # Show logs every 10 attempts for debugging unhealthy state
            if [ $((ATTEMPT % 10)) -eq 0 ]; then
              echo ""
              echo "--- Precision API recent logs ---"
              docker compose -f docker-compose.e2e.yml logs --tail=10 precision-api
              echo ""
              echo "--- Intelligence API recent logs ---"
              docker compose -f docker-compose.e2e.yml logs --tail=10 intelligence-api
              echo ""
            fi
            
            sleep 2
          done
          
          echo "‚ùå Services failed to become healthy after $MAX_ATTEMPTS attempts"
          echo ""
          echo "=== Final Container Status ==="
          docker compose -f docker-compose.e2e.yml ps
          echo ""
          echo "=== Complete Logs ==="
          docker compose -f docker-compose.e2e.yml logs
          exit 1
      
      - name: üß™ Run E2E Integration Test
        working-directory: workspace/agro-tech-ecosystem
        timeout-minutes: 3
        run: |
          python integration/test_precision_to_intelligence.py
      
      - name: üìã Show container logs (on failure)
        if: failure()
        working-directory: workspace/agro-tech-ecosystem
        run: |
          echo "=== Docker Compose Status ==="
          docker compose -f docker-compose.e2e.yml ps
          echo ""
          echo "=== Container Logs ==="
          docker compose -f docker-compose.e2e.yml logs
      
      - name: üõë Stop services
        if: always()
        working-directory: workspace/agro-tech-ecosystem
        run: |
          docker compose -f docker-compose.e2e.yml down -v
      
      - name: üíæ Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: |
            workspace/agro-tech-ecosystem/integration/*.log
          retention-days: 7
          if-no-files-found: ignore
